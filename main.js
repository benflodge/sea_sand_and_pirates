(()=>{"use strict";var t=32,e=64,n=4e3,i=.0016,a=(Math.PI,Math.PI/2),o=Math.PI+a,h={PORT:a,STARBOARD:o};Object.keys(h);const s=["compass-arrow","sea-sand","canvas","map-canvas","matrix-svg","audio-control","music-control","audio-control-audio-off","audio-control-audio-on","audio-control-music-off","audio-control-music-on","help","help-popup","help-close","restart-game-button","start-popup","start-game-button","start-game-seed","ui-controls","game-over-popup","try-again-button","win-popup","new-game-button"];var r=function(t,e){return e.addEventListener?function(e,n,i){if(e&&!e.length||e===t)e.addEventListener(n,i,!1);else if(e&&e.length)for(var a=e.length,o=0;o<a;o++)r(e[o],n,i)}:e.attachEvent?function(e,n,i){if(e&&!e.length||e===t)e.attachEvent("on"+n,(function(){return i.call(e,t.event)}));else if(e.length)for(var a=e.length,o=0;o<a;o++)r(e[o],n,i)}:void 0}(void 0,document),l={37:"left",38:"up",39:"right",40:"down"};function u(t){return l[t]||String.fromCharCode(t).toLowerCase()}function c(t){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function d(t){return 0|t}function p(t,e){return t=Math.ceil(t),e=d(e),d(Math.random()*(e-t))+t}function g(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32;return{x:d(t/n),y:d(e/n)}}function m(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32;return{x:d(t)*n,y:d(e)*n}}function f(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,a=g(e,n,i);return!t[a.y]||1!==t[a.y][a.x]}function y(t,e,n){return t<e?e:t>n?n:t}function w(t,e){return Math.atan2(e.position[1]-t.position[1],e.position[0]-t.position[0])}function v(t,e){var n=e-t;return n>Math.PI&&(n-=2*Math.PI),n<-Math.PI&&(n+=2*Math.PI),n}function b(t){for(var e=!0,n=0;n<t.length&&(e=c(arguments[n+1])===t[n]);n++);return e}const x={x:0,y:0,isInViewport:function(t,e,n,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:200;return t>-this.x-a&&t<-this.x+n+a&&e>-this.y-a&&e<-this.y+i+a},calculateX:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;return y(e/2-t,e-n-i,i)},calculateY:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;return y(e/2-t,e-n-i,i)},setX:function(t,e,n){this.x=d(this.calculateX(t,e,n))},setY:function(t,e,n){this.y=d(this.calculateY(t,e,n))}};function S(t){var e;this[(e=t,e.replace(/(-\w)/g,(function(t){return t[1].toUpperCase()})))]=document.getElementById(t)}var C=window.AudioContext||window.webkitAudioContext;const P={audioEnabled:!0,create:function(t){var e=Object.create(this);return e.audioContext=new C,e.audioFiles=t,e.loadSounds(t),e.gainNode=e.audioContext.createGain(),e},loadSounds:function(t){var e=this;Object.keys(t).forEach((function(n){return e.loadSound(t,n)}))},loadSound:function(t,e){var n=this,i=new XMLHttpRequest;i.open("GET",t[e].src,!0),i.responseType="arraybuffer",i.onload=function(){n.audioContext.decodeAudioData(i.response,(function(n){t[e].sound=n}),console.error)},i.send()},playSound:function(t){if(this.audioEnabled){"suspended"===this.audioContext.state&&this.audioContext.resume();var e=this.audioContext.createBufferSource();return e.buffer=t,e.connect(this.audioContext.destination),e.start(0),e}},getSoundBuffer:function(t){return this.audioFiles&&this.audioFiles[t]&&this.audioFiles[t].sound},enableSound:function(){!1===this.audioEnabled&&(this.audioContext.resume(),this.audioEnabled=!0)},disableSound:function(){!0===this.audioEnabled&&(this.audioContext.suspend(),this.audioEnabled=!1)},isEnabled:function(){return this.audioEnabled}},L={cannon1:{src:"./assets/audio/cannons/cannon-1.mp3",sound:null},cannon2:{src:"./assets/audio/cannons/cannon-2.mp3",sound:null},cannon3:{src:"./assets/audio/cannons/cannon-3.mp3",sound:null},cannon4:{src:"./assets/audio/cannons/cannon-4.mp3",sound:null},cannon5:{src:"./assets/audio/cannons/cannon-5.mp3",sound:null},cannon6:{src:"./assets/audio/cannons/cannon-6.mp3",sound:null},cannon7:{src:"./assets/audio/cannons/cannon-7.mp3",sound:null}},E={create:function(){var t=Object.create(this);return t.audio=P.create(L),t},playCannonSound:function(){if(this.audio.isEnabled()){var t=p(1,8),e=this.audio.getSoundBuffer("cannon".concat(t));e&&this.audio.playSound(e)}}};var T={};function A(t){t.uiElements.helpPopup.classList.toggle("hidden"),t.currentGame&&t.currentGame.stop()}function M(t,e,n){e?(t.uiElements["audioControl".concat(n,"Off")].classList.add("hidden"),t.uiElements["audioControl".concat(n,"On")].classList.remove("hidden")):(t.uiElements["audioControl".concat(n,"Off")].classList.remove("hidden"),t.uiElements["audioControl".concat(n,"On")].classList.add("hidden"))}function O(t){t.uiElements.startPopup.classList.toggle("hidden")}function k(t){t.currentGame&&t.currentGame.stop(),t.uiElements.gameOverPopup.classList.toggle("hidden")}function B(t){t.currentGame&&t.currentGame.stop(),t.uiElements.winPopup.classList.toggle("hidden")}var I=null;function R(t){if(this.running){window.requestAnimationFrame(this.gameLoop),t||(t=0);var e=this.previous?(t-this.previous)/1e3:0;this.update(this.view,this.frameDuration,e,this.maxSubSteps,t),this.draw(this.view,t),this.previous=t}}var j={maxSubSteps:10,frameDuration:1/30};const G={update:null,draw:null,view:null,running:!1,previous:0,lag:0,create:function(t,e,n){if(!b(["object","function","function"],t,e,n))return null;var i=Object.create(this);return i.gameLoop=R.bind(i),Object.assign(i,j,{view:t,update:e,draw:n}),i},run:function(){return!I&&(this.running=!0,I=this,this.gameLoop(),!0)},stop:function(){this.running=!1,this.previous=null,I=null}},V={imagePath:"shipsMiscellaneous_sheet.png",SubTexture:[{name:"cannon.png",x:"88",y:"422",width:"29",height:"16"},{name:"cannonBall.png",x:"120",y:"29",width:"10",height:"10"},{name:"cannonLoose.png",x:"439",y:"496",width:"20",height:"12"},{name:"cannonMobile.png",x:"408",y:"489",width:"29",height:"20"},{name:"crew (1).png",x:"511",y:"489",width:"22",height:"20"},{name:"crew (2).png",x:"463",y:"489",width:"22",height:"20"},{name:"crew (3).png",x:"487",y:"489",width:"22",height:"20"},{name:"crew (4).png",x:"568",y:"469",width:"22",height:"22"},{name:"crew (5).png",x:"439",y:"472",width:"22",height:"22"},{name:"crew (6).png",x:"544",y:"469",width:"22",height:"22"},{name:"dinghyLarge1.png",x:"606",y:"145",width:"20",height:"38"},{name:"dinghyLarge2.png",x:"610",y:"426",width:"20",height:"38"},{name:"dinghyLarge3.png",x:"588",y:"426",width:"20",height:"38"},{name:"dinghySmall1.png",x:"628",y:"166",width:"16",height:"26"},{name:"dinghySmall2.png",x:"612",y:"110",width:"16",height:"26"},{name:"dinghySmall3.png",x:"628",y:"138",width:"16",height:"26"},{name:"explosion1.png",x:"0",y:"0",width:"74",height:"75"},{name:"explosion2.png",x:"544",y:"145",width:"60",height:"59"},{name:"explosion3.png",x:"544",y:"426",width:"42",height:"41"},{name:"fire1.png",x:"614",y:"466",width:"18",height:"39"},{name:"fire2.png",x:"120",y:"0",width:"11",height:"27"},{name:"flag (1).png",x:"120",y:"41",width:"6",height:"22"},{name:"flag (2).png",x:"600",y:"486",width:"6",height:"22"},{name:"flag (3).png",x:"630",y:"110",width:"6",height:"22"},{name:"flag (4).png",x:"128",y:"41",width:"6",height:"22"},{name:"flag (5).png",x:"592",y:"486",width:"6",height:"22"},{name:"flag (6).png",x:"632",y:"426",width:"6",height:"22"},{name:"hullLarge (1).png",x:"596",y:"316",width:"50",height:"108"},{name:"hullLarge (2).png",x:"544",y:"206",width:"50",height:"108"},{name:"hullLarge (3).png",x:"596",y:"206",width:"50",height:"108"},{name:"hullLarge (4).png",x:"544",y:"316",width:"50",height:"108"},{name:"hullSmall (1).png",x:"612",y:"0",width:"40",height:"108"},{name:"hullSmall (2).png",x:"648",y:"330",width:"40",height:"108"},{name:"hullSmall (3).png",x:"648",y:"110",width:"40",height:"108"},{name:"hullSmall (4).png",x:"648",y:"220",width:"40",height:"108"},{name:"nest.png",x:"592",y:"466",width:"20",height:"18"},{name:"pole.png",x:"119",y:"422",width:"12",height:"11"},{name:"sailLarge (1).png",x:"408",y:"279",width:"66",height:"47"},{name:"sailLarge (10).png",x:"408",y:"328",width:"66",height:"46"},{name:"sailLarge (11).png",x:"408",y:"376",width:"66",height:"46"},{name:"sailLarge (12).png",x:"408",y:"424",width:"66",height:"46"},{name:"sailLarge (13).png",x:"476",y:"0",width:"66",height:"47"},{name:"sailLarge (14).png",x:"476",y:"49",width:"66",height:"47"},{name:"sailLarge (15).png",x:"136",y:"460",width:"66",height:"47"},{name:"sailLarge (16).png",x:"68",y:"460",width:"66",height:"47"},{name:"sailLarge (17).png",x:"476",y:"98",width:"66",height:"47"},{name:"sailLarge (18).png",x:"476",y:"147",width:"66",height:"47"},{name:"sailLarge (19).png",x:"476",y:"293",width:"66",height:"47"},{name:"sailLarge (2).png",x:"272",y:"460",width:"66",height:"47"},{name:"sailLarge (20).png",x:"204",y:"460",width:"66",height:"47"},{name:"sailLarge (21).png",x:"340",y:"460",width:"66",height:"47"},{name:"sailLarge (22).png",x:"476",y:"244",width:"66",height:"47"},{name:"sailLarge (23).png",x:"408",y:"230",width:"66",height:"47"},{name:"sailLarge (24).png",x:"476",y:"342",width:"66",height:"47"},{name:"sailLarge (3).png",x:"476",y:"391",width:"66",height:"47"},{name:"sailLarge (4).png",x:"476",y:"440",width:"66",height:"47"},{name:"sailLarge (5).png",x:"544",y:"0",width:"66",height:"47"},{name:"sailLarge (6).png",x:"0",y:"460",width:"66",height:"47"},{name:"sailLarge (7).png",x:"476",y:"196",width:"66",height:"46"},{name:"sailLarge (8).png",x:"544",y:"97",width:"66",height:"46"},{name:"sailLarge (9).png",x:"544",y:"49",width:"66",height:"46"},{name:"sailSmall (1).png",x:"0",y:"422",width:"42",height:"9"},{name:"sailSmall (10).png",x:"44",y:"422",width:"42",height:"9"},{name:"sailSmall (11).png",x:"0",y:"433",width:"42",height:"9"},{name:"sailSmall (12).png",x:"44",y:"433",width:"42",height:"9"},{name:"sailSmall (13).png",x:"44",y:"444",width:"42",height:"9"},{name:"sailSmall (2).png",x:"0",y:"444",width:"42",height:"9"},{name:"sailSmall (3).png",x:"76",y:"0",width:"42",height:"8"},{name:"sailSmall (4).png",x:"76",y:"10",width:"42",height:"8"},{name:"sailSmall (5).png",x:"76",y:"20",width:"42",height:"8"},{name:"sailSmall (6).png",x:"76",y:"30",width:"42",height:"8"},{name:"sailSmall (7).png",x:"76",y:"40",width:"42",height:"9"},{name:"sailSmall (8).png",x:"76",y:"62",width:"42",height:"9"},{name:"sailSmall (9).png",x:"76",y:"51",width:"42",height:"9"},{name:"ship (1).png",x:"408",y:"0",width:"66",height:"113"},{name:"ship (10).png",x:"340",y:"345",width:"66",height:"113"},{name:"ship (11).png",x:"340",y:"230",width:"66",height:"113"},{name:"ship (12).png",x:"340",y:"115",width:"66",height:"113"},{name:"ship (13).png",x:"340",y:"0",width:"66",height:"113"},{name:"ship (14).png",x:"272",y:"345",width:"66",height:"113"},{name:"ship (15).png",x:"272",y:"230",width:"66",height:"113"},{name:"ship (16).png",x:"272",y:"115",width:"66",height:"113"},{name:"ship (17).png",x:"272",y:"0",width:"66",height:"113"},{name:"ship (18).png",x:"204",y:"345",width:"66",height:"113"},{name:"ship (19).png",x:"204",y:"230",width:"66",height:"113"},{name:"ship (2).png",x:"408",y:"115",width:"66",height:"113"},{name:"ship (20).png",x:"204",y:"0",width:"66",height:"113"},{name:"ship (21).png",x:"136",y:"345",width:"66",height:"113"},{name:"ship (22).png",x:"136",y:"230",width:"66",height:"113"},{name:"ship (23).png",x:"136",y:"115",width:"66",height:"113"},{name:"ship (24).png",x:"136",y:"0",width:"66",height:"113"},{name:"ship (3).png",x:"204",y:"115",width:"66",height:"113"},{name:"ship (4).png",x:"68",y:"192",width:"66",height:"113"},{name:"ship (5).png",x:"68",y:"77",width:"66",height:"113"},{name:"ship (6).png",x:"68",y:"307",width:"66",height:"113"},{name:"ship (7).png",x:"0",y:"192",width:"66",height:"113"},{name:"ship (8).png",x:"0",y:"307",width:"66",height:"113"},{name:"ship (9).png",x:"0",y:"77",width:"66",height:"113"},{name:"wood (1).png",x:"88",y:"449",width:"15",height:"7"},{name:"wood (2).png",x:"408",y:"472",width:"26",height:"10"},{name:"wood (3).png",x:"116",y:"440",width:"15",height:"10"},{name:"wood (4).png",x:"88",y:"440",width:"26",height:"7"}]};var X="SHIP",Y={cannonSpeed:600,speed:60,hull:300,shipImageTile:91};const F={firing:!1,type:X,create:function(t,e,n,i){var a=t.game;if(!b(["object","number","number"],t,e,n))return null;var o=Object.create(this);Object.assign(o,Y,i),o.active=!0,o.view=t;var h=new p2.Circle({radius:1});return o.body=new p2.Body({mass:30,damping:.3,angularDamping:0,position:[e/32,n/32]}),o.body.parent=o,o.body.addShape(h),a.physics.world.addBody(o.body),o},fireStarboard:function(t){this.fire(t,"STARBOARD")},firePort:function(t){this.fire(t,"PORT")},fire:function(t,e){if(!this.firing){this.firing=!0;var n={xVel:this.getXVel(),yVel:this.getYVel(),angle:this.getAngle()+h[e],parent:this};t.add(this.view,this.getX(),this.getY(),n),window.setTimeout(this.fireFinished.bind(this),this.cannonSpeed)}},fireFinished:function(){this.firing=!1},damageHull:function(t,e){this.hull-="number"==typeof e?e:100,this.hull<=0&&this.setActive(t,!1)},draw:function(t,e){if(this.isActive()){var n=t.context,i=this.findRenderPoint();if(n.save(),n.beginPath(),n.translate(d(32*i[0]+t.viewport.x),d(32*i[1]+t.viewport.y)),n.rotate(this.getAngle()),n.drawImage(e,V.SubTexture[this.shipImageTile].x,V.SubTexture[this.shipImageTile].y,V.SubTexture[this.shipImageTile].width,V.SubTexture[this.shipImageTile].height,-30,-50,60,100),window.debug&&(n.beginPath(),n.arc(0,0,32,0,2*Math.PI),n.stroke(),n.arc(0,0,192,0,2*Math.PI),n.stroke()),n.restore(),window.debug){if(this.path)for(var a=0;a<this.path.length;a++){var o=this.path[a];t.mapContext.save(),t.mapContext.translate(o[0],o[1]),t.mapContext.fillStyle="orange",t.mapContext.fillRect(0,0,2,2),t.mapContext.restore()}if(this.path)for(var h=0;h<this.path.length;h++){var s=this.path[h],r=m(s[0],s[1]);n.save(),n.translate(r.x+16+t.viewport.x,r.y+16+t.viewport.y),n.fillStyle="orange",n.fillRect(0,0,4,4),n.restore()}}}},findRenderPoint:function(){return this.body?this.body.interpolatedPosition:null},findRenderX:function(){return this.body?this.body.interpolatedPosition[0]:null},findRenderY:function(){return this.body?this.body.interpolatedPosition[1]:null},getX:function(){return this.body?this.body.position[0]:null},getY:function(){return this.body?this.body.position[1]:null},getXVel:function(){return this.body?this.body.velocity[0]:null},getYVel:function(){return this.body?this.body.velocity[1]:null},getRenderAngle:function(){return this.body.interpolatedAngle},getAngle:function(){return this.body?this.body.angle:null},setActive:function(t,e){var n=t.game;"boolean"==typeof e&&(this.active=e,e||(n.physics.removeBodies.push(this.body),this.body.parent=null,this.body=null))},isActive:function(){return this.active}};var D="CANNON_BALL";const H={parent:null,dieTime:null,type:D,create:function(t,e,n,i){if(!b(["object","number","number"],t,e,n))return null;var a=Object.create(this);return a?this.setProps(a,t,e,n,i):null},reset:function(t,e,n,i){return this.body?null:this.setProps(this,t,e,n,i)},setProps:function(t,e,n,i,a){var o=e.game,h=a.xVel,s=a.yVel,r=a.parent,l=a.angle;if(!b(["number","number","number","object"],h,s,l,r))return null;l+=Math.PI/2,t.parent=r,t.active=!0,t.dieTime=o.physics.world.time+1.4,t.body=new p2.Body({mass:4,damping:.3,angularDamping:0,position:[1*Math.cos(l)+n,1*Math.sin(l)+i],velocity:[6*Math.cos(l)+h,6*Math.sin(l)+s]});var u=new p2.Circle({radius:.1});return t.body.parent=t,t.body.addShape(u),o.physics.world.addBody(t.body),e.sfx.playCannonSound(e),t},update:function(t){var e=t.game;this.isActive()&&this.dieTime<=e.physics.world.time&&this.setActive(t,!1)},setActive:function(t,e){var n=t.game;"boolean"==typeof e&&(this.active=e,e||(n.physics.removeBodies.push(this.body),this.body.parent=null,this.body=null))},isActive:function(){return this.active},findRenderPoint:function(){return this.body?this.body.interpolatedPosition:null},findRenderX:function(){return this.body?this.body.interpolatedPosition[0]:null},findRenderY:function(){return this.body?this.body.interpolatedPosition[1]:null},getX:function(){return this.body?this.body.position[0]:null},getY:function(){return this.body?this.body.position[1]:null},getAngle:function(){return this.body?this.body.interpolatedAngle:null},draw:function(e,n){this.isActive()&&e.context.drawImage(n.pirateShips,V.SubTexture[1].x,V.SubTexture[1].y,V.SubTexture[1].width,V.SubTexture[1].height,d(this.getX()*t+e.viewport.x),d(this.getY()*t+e.viewport.y),10,10)}};var W="wall";var N=null;function _(t){var e=null;switch(t){case 3:e=[2,2];break;case 5:e=[0,2];break;case 7:e=[1,2];break;case 10:e=[2,0];break;case 11:e=[2,1];break;case 12:e=[0,0];break;case 13:e=[0,1];break;case 14:e=[1,0];break;case 15:e=[3,4];break;default:e=[1,4]}return e}function q(t,e){e.isActive()&&(t.save(),t.translate(d(e.getX()),d(e.getY())),t.fillStyle=e.color||"black",t.fillRect(0,0,2,2),t.restore())}function U(t,e,n,i,a){var o=t.game,h=o.physics,s=o.actors;h.timeStamp=a,s.cannonBalls.collection.forEach((function(e){return e.update(t)})),h.removeBodies.forEach((function(t){h.world.removeBody(t)})),h.world.step(e,n,i)}const z={create:function(){var t=F.create.apply(F,arguments);return t?t=Object.assign(t,this):null},makeMove:function(t,e){this.updateControls(t.keyDown,e.actors.cannonBalls),this.updateAngle(t.keyDown,e.actors.cannonBalls)},updateControls:function(t,e){this.isActive()&&(t.c&&this.fireStarboard(e),t.v&&this.firePort(e))},updateAngle:function(t){this.isActive()&&(t.up&&this.body.applyForceLocal([0,this.speed]),t.right?this.body.angularVelocity=1:t.left?this.body.angularVelocity=-1:this.body.angularVelocity=0)}};var J={shipImageTile:93,cannonRange:192};const K={losTime:null,targetAngle:null,lineOfSight:!1,create:function(t,e,n,i){var a=t.game;if(!b(["object","object","number","number"],t,a,e,n))return null;var o=F.create.apply(F,arguments);return o?Object.assign(o,J,i,this):null},makeMove:function(t){var e=t.game,n=e.actors.playerShip,i=e.actors.cannonBalls,a=e.physics.timeStamp,o=e.aStarGraph;if(this.isActive())if(n.isActive()){var h,s,r,l,u={ship:n,angleToShip:w(this.body,n.body),distance:(h=this.body,s=n.body,r=s.position[0]-h.position[0],l=s.position[1]-h.position[1],Math.sqrt(r*r+l*l))};a>this.losTime+1&&(this.hasLineOfSight(t,u),this.losTime=a,this.path=window.path=null);var c,d=(c=this.getAngle(),(c%=2*Math.PI)<0&&(c+=2*Math.PI),c),p=v(d,u.angleToShip);this.body.angularVelocity=0,this.lineOfSight&&32*u.distance<192&&p>=0&&p<.24?(this.turnToBroadside(p),this.fireStarboard(i)):this.lineOfSight&&32*u.distance<192&&p>2.9&&p<3.5?(this.turnToBroadside(p),this.firePort(i)):this.lineOfSight&&32*u.distance<192?this.turnToBroadside(p):this.lineOfSight?this.followShip(u,d):this.path&&this.path.length?this.followCourseToShip(u,o,d):this.plotCourseToShip(u,o,d)}else this.body.angularVelocity=0},hasLineOfSight:function(t,e){var n=this,i=this.getX(),a=this.getY(),o=e.ship.getX(),h=e.ship.getY(),s=new p2.RaycastResult,r=new p2.Ray({mode:p2.Ray.ALL,from:[i,a],to:[o,h],callback:function(t){return n.rayCallback(t,e,r)}});t.game.physics.world.raycast(s,r)},rayCallback:function(t,e){if(this.body!==t.body){if(e.ship.body!==t.body)return t.body.parent&&W===t.body.parent.type?(this.lineOfSight=!1,void t.stop()):void 0;this.lineOfSight=!0}},turnToBroadside:function(t){t>.01&&t<1.49?this.body.angularVelocity=1:t<-.01&&t>=-1.5||t>1.5&&t<3.1?this.body.angularVelocity=-1:t<-1.5&&t>-3.1&&(this.body.angularVelocity=1)},followShip:function(t,e){this.turnToward(e,t.angleToShip),this.body.applyForceLocal([0,this.speed])},turnToward:function(t,e){var n=v(t-o,e);Math.abs(n)<.01||(this.body.angularVelocity=n>0?1:-1)},followCourseToShip:function(t,e,n){var i=null;this.path&&this.path.length&&(this.findWayPoint(this.path),i=this.findDirectionFromPath(this.path)),i&&this.turnToward(n,i),this.body.applyForceLocal([0,20])},findWayPoint:function(t){var e=function(t,e){return t>=e&&t<=e+32},n=m(t[0][0],t[0][1]),i=m(this.getX(),this.getY());e(i.x,n.x)&&e(i.y,n.y)&&t.shift()},findDirectionFromPath:function(t){if(t.length){var e=m(t[0][0],t[0][1]),n=m(this.getX(),this.getY());return w({position:[n.x,n.y]},{position:[e.x,e.y]})}return null},plotCourseToShip:function(t,e){this.path=this.findPathToShip(t.ship,e),this.followCourseToShip.apply(this,arguments)},findPathToShip:function(t,e){var n=function(t,e){return t>=0&&t<e?t:Math.floor(e/2)},i=new PF.AStarFinder({turnPenalty:20,avoidStarcasing:!0,allowDiagonal:!0});return window.path=i.findPath(n(Math.floor(this.getX()),e.width),n(Math.floor(this.getY()),e.width),n(Math.floor(t.getX()),e.width),n(Math.floor(t.getY()),e.width),e.clone())}},Q={create:function(){var t=Object.create(this);return t.vector=p2.vec2.fromValues(0,.1),t},getAngleDegrees:function(){return Math.atan2(this.vector[0],this.vector[1])*(180/Math.PI)},changeWind:function(){}},Z={collection:null,create:function(t){var e=Object.create(this);return e.collection=[],e.pooledObject=t,e},add:function(){var t=null;this.isObjectReady()&&(t=this.collection.shift()).reset.apply(t,arguments),t||(t=this.pooledObject.create.apply(this.pooledObject,arguments)),this.collection.push(t)},isObjectReady:function(){return this.collection[0]&&!this.collection[0].isActive()},clean:function(){for(var t=0;t<this.collection.length&&!this.collection[t].isActive();t++);t>1&&this.collection.splice(0,t-1)}},$=[{},{},{shipImageTile:94,hull:800},{shipImageTile:96,cannonSpeed:400},{shipImageTile:96,cannonSpeed:400},{shipImageTile:96,cannonSpeed:400}];function tt(t){var e,n;do{e=p(0,t.length),n=p(0,t.length)}while(!f(t,e,n));return m(e,n)}function et(i,a){var o=i.game,h=o.actors,s=h.playerShip.findRenderPoint();s&&(i.viewport.setX(t*s[0],i.width,n),i.viewport.setY(t*s[1],i.height,n)),i.uiElements.canvas.style="background-position: ".concat(d(i.viewport.x)%e,"px ").concat(d(i.viewport.y)%e,"px;"),i.context.clearRect(0,0,i.width,i.height),function(n,i,a){n.context.beginPath();for(var o=0;o<i.length;o++)for(var h=0;h<i[o].length;h++){var s=i[o][h];if("number"==typeof s){var r=_(s),l=h*t,u=o*t;n.viewport.isInViewport(l,u,n.width,n.height)&&n.context.drawImage(a.sandTileSet,r[0]*e,r[1]*e,e,e,d(l+n.viewport.x)-16,d(u+n.viewport.y)-16,t,t)}}}(i,o.tileMapValues,i.assets),h.playerShip.draw(i,i.assets.pirateShips),h.enemyShips.forEach((function(t){t.draw(i,i.assets.pirateShips)})),h.cannonBalls.collection.forEach((function(t){return t.draw(i,i.assets)})),a&&(i.mapContext.beginPath(),i.mapContext.clearRect(0,0,i.mapWidth,i.mapHeight),function(t,e){t.save();for(var n=0;n<e.length;n++)for(var i=0;i<e[n].length;i++){var a=e[n][i];if("number"==typeof a){var o=d(1*i),h=d(1*n);t.fillStyle=1===a?"#dbbe64":"#2a82a8",t.fillRect(o,h,1,1)}}t.restore()}(i.mapContext,o.map),q(i.mapContext,h.playerShip),h.enemyShips.forEach((function(t){q(i.mapContext,t)}))),Math.random()}const nt=[{name:"sandTileSet",url:"./assets/image/tilesheet/tiles_sheet.png"},{name:"pirateShips",url:"./assets/image/spritesheet/shipsMiscellaneous_sheet.png"}];function it(t){var e={};return t.forEach((function(t){e[t.name]=t.image})),e}var at=function(){var t=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.forEach(S,e),e}(s),e=t.seaSand.getContext("2d"),n=t.canvas.getContext("2d"),i=t.mapCanvas.getContext("2d"),a=t.mapCanvas.height=125,o=t.mapCanvas.width=125,h=t.seaSand.height=t.canvas.height=window.innerHeight,l=t.seaSand.width=t.canvas.width=window.innerWidth,c=E.create(),d={keyDown:T,sfx:c,uiElements:t,ui:{},seaContext:e,context:n,mapContext:i,mapHeight:a,mapWidth:o,height:h,width:l,viewport:x};return r(document.body,"keydown",(function(t){!function(t,e){var n=(t=t||window.event).charCode||t.keyCode;n&&(e[u(n)]=!0)}(t,T)})),r(document.body,"keyup",(function(t){!function(t,e){var n=(t=t||window.event).charCode||t.keyCode;n&&(e[u(n)]=!1)}(t,T)})),function(t){r(t.uiElements.uiControls,"click",(function(e){switch(e.target.parentElement){case t.uiElements.audioControl:!function(t){var e=t.sfx.audio.isEnabled();e?t.sfx.audio.disableSound():t.sfx.audio.enableSound(),M(t,!e,"Audio")}(t);break;case t.uiElements.musicControl:!function(t){var e=t.music.audio.isEnabled();e?t.music.audio.disableSound():t.music.audio.enableSound(),M(t,!e,"Music")}(t);break;case t.uiElements.help:A(t)}}))}(d),function(t){r(t.uiElements.startPopup,"click",(function(e){switch(e.target){case t.uiElements.startGameButton:O(t);var n=t.uiElements.startGameSeed.valueAsNumber;t.startGame(n>=0||n<=65536?n:0)}})),t.ui.toggleMenu=function(){return O(t)}}(d),function(t){r(t.uiElements.helpPopup,"click",(function(e){switch(e.target){case t.uiElements.helpPopup:case t.uiElements.helpClose:t.uiElements.helpPopup.classList.toggle("hidden"),t.currentGame&&t.currentGame.run();break;case t.uiElements.restartGameButton:t.uiElements.helpPopup.classList.toggle("hidden"),t.ui.toggleMenu()}})),t.ui.pause=function(){return A(t)}}(d),function(t){r(t.uiElements.gameOverPopup,"click",(function(e){switch(e.target){case t.uiElements.tryAgainButton:k(t),t.ui.toggleMenu()}})),t.ui.gameOver=function(){return k(t)}}(d),function(t){r(t.uiElements.winPopup,"click",(function(e){switch(e.target){case t.uiElements.newGameButton:B(t),t.ui.toggleMenu()}})),t.ui.winGame=function(){return B(t)}}(d),d}();at.startGame=function(t){at.game={physics:null,map:null,actors:null},function(t){var e=t.game.physics={};e.removeBodies=[],e.world=new p2.World({gravity:[0,0]}),e.world.defaultContactMaterial.friction=0,e.world.applyGravity=!1,e.world.on("postStep",(function(){return function(t){var e=t.game,n=0;e.actors.enemyShips.forEach((function(i){i.isActive()&&(i.makeMove(t,e.actors.playerShip,e.physics.timeStamp,e.actors.cannonBalls,e.aStarGraph),n++)})),e.actors.playerShip.isActive()?(e.actors.playerShip.makeMove(t,e),0!=n||t.ui.winGame()):t.ui.gameOver()}(t)})),e.world.on("beginContact",(function(e){return function(t,e){var n=t.bodyA.parent,i=t.bodyB.parent;n&&i&&(n.type===X&&i.type===X?(n.damageHull(e,20),i.damageHull(e,20)):n.type===X&&i.type===D&&i.parent!==n?n.damageHull(e):i.type===X&&n.type===D&&n.parent!==i?i.damageHull(e):n.type===X&&i.type===W?n.damageHull(e,50):i.type===X&&n.type===W&&i.damageHull(e,50))}(e,t)}))}(at),function(t,e){var a=t.game;a.map=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;window.noise.seed("number"==typeof n?n:0);for(var a=[],o=0;o<t;o+=32){var h=[];a.push(h);for(var s=0;s<e;s+=32){var r=window.noise.perlin2(o*i,s*i);r>.4?h.push(1):r>.32?h.push(99):h.push(N)}}return a}(n,n,e),a.mapForImages=a.map.map((function(t){return t.map((function(t){return 1===t?0:null}))})),a.tileMapValues=(o=a.mapForImages,o.map((function(t,e){return t.map((function(n,i){return null===n||0!==n?null:function(t,e,n){return t[e-1]&&0===t[e-1][n]?1:0}(o,e,i)|function(t,e){return 0===t[e+1]?4:0}(t,i)|function(t,e,n){return t[e+1]&&0===t[e+1][n]?8:0}(o,e,i)|function(t,e){return 0===t[e-1]?2:0}(t,i)}))}))),a.aStarGraph=new PF.Grid(a.map),function(t,e){for(var n=0;n<t.length;n++)for(var i=0;i<t[n].length;i++)if("number"==typeof t[n][i]){var a=new p2.Box({width:1,height:1}),o=new p2.Body({mass:0,position:[i,n]});o.addShape(a),o.parent={type:W},e.addBody(o)}}(a.tileMapValues,a.physics.world);var o}(at,t),function(t){var e=t.game,n=e.map,i=e.actors={},a=tt(n);i.playerShip=z.create(t,a.x,a.y),i.enemyShips=$.map((function(e){var i=tt(n);return K.create(t,i.x,i.y,e)})),i.cannonBalls=Z.create(H),i.mapWind=Q.create(t.compassArrow)}(at),(at.currentGame=G.create(at,U,et)).run()},function(t){return(e=nt,Promise.all(e.map((function(t){return new Promise((function(e){var n=new Image;t.image=n,n.onload=function(){return e(t)},n.src=t.url}))})))).then(it).then((function(e){t.assets=e}));var e}(at).then(at.ui.toggleMenu)})();